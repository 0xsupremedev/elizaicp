name: Setup DFX Identity & Deploy Canister

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'ic'
        type: choice
        options:
          - ic
          - local

env:
  DFX_VERSION: '0.23.0'

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest

    outputs:
      canister_id: ${{ steps.canister.outputs.CANISTER_ID }}
      principal: ${{ steps.identity.outputs.PRINCIPAL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DFX
        run: |
          wget https://github.com/dfinity/sdk/releases/download/${DFX_VERSION}/dfx-${DFX_VERSION}-x86_64-linux.tar.gz
          tar -xzf dfx-${DFX_VERSION}-x86_64-linux.tar.gz
          mkdir -p $HOME/.local/share/dfx/bin
          mv dfx $HOME/.local/share/dfx/bin/
          chmod +x $HOME/.local/share/dfx/bin/dfx
          echo "$HOME/.local/share/dfx/bin" >> $GITHUB_PATH

      - name: Verify DFX installation
        run: |
          export PATH="$HOME/.local/share/dfx/bin:$PATH"
          dfx --version

      - name: Create or Restore Identity
        id: identity
        run: |
          if [ -z "${{ secrets.DFX_IDENTITY_PEM }}" ]; then
            echo "ðŸ”‘ No identity found, creating new deployer identity..."
            dfx identity new deployer --storage-mode plaintext || true
            dfx identity use deployer

            PRINCIPAL=$(dfx identity get-principal)
            echo "PRINCIPAL=$PRINCIPAL" >> $GITHUB_OUTPUT

            echo "====== BEGIN IDENTITY ======"
            dfx identity export deployer
            echo "====== END IDENTITY ======"
          else
            echo "âœ… Using existing identity from secrets"
            echo "${{ secrets.DFX_IDENTITY_PEM }}" > deployer.pem
            dfx identity import deployer deployer.pem --force
            dfx identity use deployer
            rm deployer.pem

            PRINCIPAL=$(dfx identity get-principal)
            echo "PRINCIPAL=$PRINCIPAL" >> $GITHUB_OUTPUT
          fi

      - name: Show Principal
        run: |
          echo "ðŸ” Deploying with principal: ${{ steps.identity.outputs.PRINCIPAL }}"

      - name: Create Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx canister create token_factory --network ${{ github.event.inputs.network }}

      - name: Build Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx build token_factory

      - name: Deploy Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx deploy token_factory --network ${{ github.event.inputs.network }} --yes

      - name: Get Canister ID
        id: canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          CANISTER_ID=$(dfx canister id token_factory --network ${{ github.event.inputs.network }})
          echo "CANISTER_ID=$CANISTER_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployed canister: $CANISTER_ID"

      - name: Verify Deployment
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx canister status token_factory --network ${{ github.event.inputs.network }}

      - name: Create Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Canister Information" >> $GITHUB_STEP_SUMMARY
          echo "**Canister ID:** \`${{ steps.canister.outputs.CANISTER_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Principal:** ${{ steps.identity.outputs.PRINCIPAL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dashboard: https://dashboard.internetcomputer.org/canister/${{ steps.canister.outputs.CANISTER_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ If this was your first deployment, save the identity PEM from logs into GitHub Secrets as DFX_IDENTITY_PEM" >> $GITHUB_STEP_SUMMARY
