name: Setup DFX Identity & Deploy Canister

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'ic'
        type: choice
        options:
          - ic
          - local

env:
  DFX_VERSION: '0.15.0'

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DFX
        run: |
          curl -fsSL https://internetcomputer.org/install.sh | sh
          echo "$HOME/.local/share/dfx/bin" >> $GITHUB_PATH
          
      - name: Verify DFX installation
        run: dfx --version

      - name: Create or Restore Identity
        id: identity
        run: |
          # Check if secret exists, if not create new identity
          if [ -z "${{ secrets.DFX_IDENTITY_PEM }}" ]; then
            echo "ðŸ”‘ No identity found, creating new deployer identity..."
            dfx identity new deployer --storage-mode plaintext || true
            dfx identity use deployer
            
            # Export for display (will be shown in logs - save this!)
            echo "ðŸ“ IMPORTANT: Save this identity for future use!"
            echo "====== BEGIN IDENTITY ======"
            dfx identity export deployer
            echo "====== END IDENTITY ======"
            echo "âš ï¸  Add this to GitHub Secrets as DFX_IDENTITY_PEM"
          else
            echo "âœ… Using existing identity from secrets"
            echo "${{ secrets.DFX_IDENTITY_PEM }}" > deployer.pem
            dfx identity import deployer deployer.pem --force
            dfx identity use deployer
            rm deployer.pem
          fi
          
      - name: Show Principal
        run: |
          echo "ðŸ” Deploying with principal: $(dfx identity get-principal)"
          echo "PRINCIPAL=$(dfx identity get-principal)" >> $GITHUB_OUTPUT

      - name: Create Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx canister create token_factory --network ${{ github.event.inputs.network || 'ic' }} || echo "Canister already exists"

      - name: Build Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx build token_factory

      - name: Deploy Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx deploy token_factory --network ${{ github.event.inputs.network || 'ic' }} --yes

      - name: Get Canister ID
        id: canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          CANISTER_ID=$(dfx canister id token_factory --network ${{ github.event.inputs.network || 'ic' }})
          echo "CANISTER_ID=$CANISTER_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployed canister: $CANISTER_ID"

      - name: Verify Deployment
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          dfx canister status token_factory --network ${{ github.event.inputs.network || 'ic' }}

      - name: Create Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Canister Information" >> $GITHUB_STEP_SUMMARY
          echo "**Canister ID:** \`${{ steps.canister.outputs.CANISTER_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** [View on IC Dashboard](https://dashboard.internetcomputer.org/canister/${{ steps.canister.outputs.CANISTER_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network || 'ic' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Principal:** ${{ steps.identity.outputs.PRINCIPAL || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Copy canister ID: \`${{ steps.canister.outputs.CANISTER_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Update Vercel env var: \`NEXT_PUBLIC_CANISTER_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy web app to production" >> $GITHUB_STEP_SUMMARY
          echo "4. Test at https://dashboard.internetcomputer.org/canister/${{ steps.canister.outputs.CANISTER_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Important" >> $GITHUB_STEP_SUMMARY
       echo "If this was your first deployment, save the identity from the logs above to GitHub Secrets as \`DFX_IDENTITY_PEM\`" >> $GITHUB_STEP_SUMMARY

    outputs:
      canister_id: ${{ steps.canister.outputs.CANISTER_ID }}
      principal: ${{ steps.identity.outputs.PRINCIPAL }}
