name: Deploy Canisters

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'ic'
        type: choice
        options:
          - ic
          - local
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DFX
        run: |
          DFX_VERSION="0.23.0"
          wget https://github.com/dfinity/sdk/releases/download/${DFX_VERSION}/dfx-${DFX_VERSION}-x86_64-linux.tar.gz
          tar -xzf dfx-${DFX_VERSION}-x86_64-linux.tar.gz
          mkdir -p $HOME/.local/share/dfx/bin
          mv dfx $HOME/.local/share/dfx/bin/
          chmod +x $HOME/.local/share/dfx/bin/dfx
          echo "$HOME/.local/share/dfx/bin" >> $GITHUB_PATH

      - name: Verify DFX
        run: |
          export PATH="$HOME/.local/share/dfx/bin:$PATH"
          dfx --version

      - name: Create Identity
        run: |
          export PATH="$HOME/.local/share/dfx/bin:$PATH"
          dfx identity new deployer --storage-mode plaintext || true
          dfx identity use deployer
          PRINCIPAL=$(dfx identity get-principal)
          echo "ðŸ” Deployer Principal: $PRINCIPAL"
          echo "PRINCIPAL=$PRINCIPAL" >> $GITHUB_OUTPUT

      - name: Check Cycles Balance
        run: |
          export PATH="$HOME/.local/share/dfx/bin:$PATH"
          echo "ðŸ’° Checking cycles balance..."
          dfx cycles --network ic balance || echo "âš ï¸ Balance check failed (expected on first run)"
          
      - name: Deploy Canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          export PATH="$HOME/.local/share/dfx/bin:$PATH"
          dfx canister create token_factory --network ${{ github.event.inputs.network || 'ic' }} || true
          dfx build token_factory
          dfx deploy token_factory --network ${{ github.event.inputs.network || 'ic' }} --yes

      - name: Get Canister ID
        id: canister
        working-directory: packages/plugin-icp/canisters/token_factory
        run: |
          export PATH="$HOME/.local/share/dfx/bin:$PATH"
          CANISTER_ID=$(dfx canister id token_factory --network ${{ github.event.inputs.network || 'ic' }})
          echo "CANISTER_ID=$CANISTER_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployed: $CANISTER_ID"
          echo "ðŸ”— Dashboard: https://dashboard.internetcomputer.org/canister/$CANISTER_ID"

      - name: Summary
        run: |
          echo "## ðŸš€ Canister Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "**ID:** \`${{ steps.canister.outputs.CANISTER_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "[Dashboard](https://dashboard.internetcomputer.org/canister/${{ steps.canister.outputs.CANISTER_ID }})" >> $GITHUB_STEP_SUMMARY
